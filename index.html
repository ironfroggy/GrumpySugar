<html>
    <head>
        <title>Game Query Fun</title>
    </head>
    <body>
        <h3>Score:<span id="score">0</span></h3>
        <div id="playground"></div>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script type="text/javascript" src="jquery.gamequery-0.5.0.js"></script>
        <script type="text/javascript" src="game-entities.js"></script>
        <script type="text/javascript">
        $(document).ready(function() {
            var PLAYGROUND_HEIGHT = 400;
            var PLAYGROUND_WIDTH = 800;
            var REFRESH_RATE = 30;

            var SPEED = 3;
            var COIN_RATE = 1000;
            var BOMB_RATE = 3333;
            
            var lowercase_letters = "abcdefghijklmnopqrstuvwxyz";

            playground = $("#playground").playground({height: PLAYGROUND_HEIGHT, width: PLAYGROUND_WIDTH})
                .addGroup("background", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT}).end()
                .addGroup("objects", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT}).end()
                .addGroup("actors", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT}).end();

            var smiley = new $.gameQuery.Animation({imageURL: "./smiley-100px.png"});

            $('#actors')
                .addSprite('player', {animation: smiley,
                    width: 100, height: 100});

            setInterval(function(){
                var x = Math.random() * PLAYGROUND_WIDTH;
                var y = Math.random() * PLAYGROUND_HEIGHT;
                new Coin('objects', x, y);
            }, COIN_RATE);
            setInterval(function(){
                var x = Math.random() * PLAYGROUND_WIDTH;
                var y = Math.random() * PLAYGROUND_HEIGHT;
                new Bomb('objects', x, y);
            }, BOMB_RATE);

            var player = $('#player');
            player
                .data('x', 0)
                .data('y', 0)
                ;

            $.playground().startGame();

            $.fn.move = function(left, top) {
                $(this).css({
                    top: function(i, v) { return parseInt(v)+top; },
                    left: function(i, v) { return parseInt(v)+left; },
                });  
            }

            var key_codes = [];
            for (var i=0; i<lowercase_letters.length; i++) {
                key_codes[65 + i] = lowercase_letters[i];
            }
            key_codes[37] = 'left';
            key_codes[38] = 'up';
            key_codes[39] = 'right';
            key_codes[40] = 'down';

            $(document).bind("keydown keyup keypress", function(e) {
                var event = new $.Event(e.type + '_' + key_codes[e.keyCode]);
                event.keyCode = e.keyCode;
                $(this).trigger(event);
            });

            $(document).bind('keyup_undefined', function(e) {
                console.log(e.type, e.keyCode);
            });

            function bind_movement_key(direction, dimension, delta) {
                $(document).bind('keydown_' + direction, function(e) {
                    player.data(dimension, delta);
                }).bind('keyup_' + direction, function(e) {
                    player.data(dimension, 0);
                });
            };
            bind_movement_key('right', 'x', SPEED);
            bind_movement_key('left', 'x', -SPEED);
            bind_movement_key('up', 'y', -SPEED);
            bind_movement_key('down', 'y', SPEED);

            $.playground().registerCallback(function(){
                player.css({
                    top: function(i, v) { return parseInt(v) + player.data('y'); },
                    left: function(i, v) { return parseInt(v) + player.data('x'); }
                });

                player.collision('#objects,.sprite').trigger('collide', [player]);
            }, REFRESH_RATE);
        });
        </script>
    </body>
</html>
